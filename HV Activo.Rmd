---
title: "<center> Dirección de Mantenimiento"
output:
  html_document:
    fig_width: 10
    number_sections: no
    toc: no
    toc_float: no
params:
  placa: "KYO810"
  desde: "2022-04-01"
  hasta: "2022-07-08"
pagetitle: Hoja de Vida del Activo
---

<p>

::: pull-right
![](https://greenmovil.com.co/wp-content/uploads/2022/01/Greenmovil_Pequeno.png){width="80%"}
:::

<h3>

Hoja de Vida del Activo

</h3>

------------------------------------------------------------------------

```{=html}
<style>
body {
    text-align: justify
    }

h1 {
  font-size: 20px;
  }
</style>
```
<h6>

**Fecha**: `r format(lubridate::today(), "%d de %B de %Y")` **Creado Por**: Área de Programación

</h6>

```{r septup, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F)
dig <- function(x) format(x, digits = 2)
library(knitr)
library(kableExtra)
library(grid)
library(tidyverse)
library(lubridate)
library(glue)
library(DT)
options(scipen = 999)
```

```{r CargueDatos, include=FALSE}
con <- DBI::dbConnect(RPostgres::Postgres(),
                      host = '10.0.22.11',
                      port = '5432',
                      dbname = 'GRMDW',
                      user = keyring::key_list("DWGM")[1,2],
                      password = keyring::key_get("DWGM", keyring::key_list("DWGM")[1,2]))

# Se obtiene las fechas actuales de los datos procesados
dim_flota <- odbc::dbGetQuery(con, glue_sql('SELECT "AssetNum", "Description", "TIPO"
                                              FROM "public"."DimFlota"
                                              WHERE "AssetNum" = {vehiculo}', 
                                            vehiculo = params$placa,
                                            .con = con))

ordenes_sql <- glue_sql('SELECT DATE("ActStart") AS "Fecha", "SiteId" as "Empresa", 
                                "AssetNum" as "Vehiculo", "Parent" as "OT", 
                                "WoNum" as "Actividad", 
                                "DescriptionOt" as "Detalle", "Status" as "Estado", 
                                "WoClass" as "Clase", "WorkType" as "Tipo", "LectOdom" as "Kms"
                                FROM "public"."FactWorkOrder"
                                WHERE "WoClass" = \'ACTIVIDAD\' 
                                AND "Status" IN (\'TERMINADO\', \'COMP\') 
                                AND "AssetNum" = {vehiculo}
                                AND DATE("ActStart") >= {desde}
                                AND DATE("ActStart") <= {hasta}
                                ORDER BY "ActStart" DESC', 
                    vehiculo = params$placa,
                    desde = params$desde,
                    hasta = params$hasta,
                    .con = con)

ordenes <- odbc::dbGetQuery(con, ordenes_sql) %>% 
  mutate_at(vars("Estado", "Clase"), .funs = str_to_title)
  

DBI::dbDisconnect(con)
```

---
# Historial de Actividades

A continuación se presentan las actividades de mantenimiento realizadas en el periodo comprendido entre el **`r params$desde`** hasta el **`r params$hasta`**.

<div class="alert alert-success" role="alert">
  Los datos corresponden al vehículo **`r params$placa`** con numero interno **`r dim_flota$Description`** y tipologia **`r dim_flota$TIPO`**
</div>

Use las siguientes opciones para descargar la información.

```{r message=FALSE, warning=FALSE}
ordenes %>% 
  select(-c("Actividad", "Estado", "Clase")) %>% 
  datatable(
    filter = 'top',
    rownames = FALSE,
    extensions = 'Buttons',
    options = list(pageLength = 15,
                   dom = 'Btrpi',
                   buttons = c('excel', 'pdf'),
                   searchHighlight = TRUE),
    caption = 'Tabla 1: Tabla Detalle.') %>% 
  formatRound("Kms", 0)
```
